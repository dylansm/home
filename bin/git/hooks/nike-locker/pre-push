#!/bin/sh

if [[ ! -n "$DEPLOY_ENV" ]]; then
  DEPLOY_ENV='staging'
fi

if [[ -n "$FETCH_ASSETS" ]]; then
  FETCH_ASSETS=false
fi

if [[ -n "$PUSH_ASSETS" ]]; then
  PUSH_ASSETS=false
fi

SSH_CONFIG=locker
USER=deployer

# local
LOCAL_APP_DIR=~/sites/nike-locker
# LOCAL_PUBLIC_DIR="$LOCAL_APP_DIR/public"
# LOCAL_ASSETS_DIR="$LOCAL_PUBLIC_DIR/assets"
LOCAL_BUILD_DIR="./build"

# staging
STAGING_APP_DIR=/home/deployer/mobile-locker-qa.nike.com
STAGING_PUBLIC_DIR="$STAGING_APP_DIR/html"
# STAGING_ASSETS_DIR="$STAGING_PUBLIC_DIR/assets"
STAGING_BUILD_DIR="$STAGING_PUBLIC_DIR"

# production
PRODUCTION_APP_DIR=/home/deployer/mobile-locker.nike.com
PRODUCTION_PUBLIC_DIR="$PRODUCTION_APP_DIR/html"
# PRODUCTION_ASSETS_DIR="$PRODUCTION_PUBLIC_DIR/assets"
PRODUCTION_BUILD_DIR="$PRODUCTION_PUBLIC_DIR"

# compile build
npm run build

ssh "$SSH_CONFIG" << ENDSSH
sudo chown "$USER:$USER" "$PRODUCTION_PUBLIC_DIR"
ENDSSH

# push up assets while in DEV ONLY
# rsync -zavr "$LOCAL_ASSETS_DIR/" "$SSH_CONFIG":"$STAGING_ASSETS_DIR"

# push up build dir - staging
if [[ "$DEPLOY_ENV" == 'staging'  ]]; then
  echo "Environment: STAGING"
  echo "Synching $LOCAL_BUILD_DIR to $SSH_CONFIG:/$STAGING_BUILD_DIR"
  rsync -zavr "$LOCAL_BUILD_DIR/" "$SSH_CONFIG":"$STAGING_BUILD_DIR"
fi

# push up build dir - production
if [[ "$DEPLOY_ENV" == 'production'  ]]; then
  echo "Environment: PRODUCTION"
  echo "Synching $LOCAL_BUILD_DIR to $SSH_CONFIG:/$PRODUCTION_BUILD_DIR"
  rsync -zavr "$LOCAL_BUILD_DIR/" "$SSH_CONFIG":"$PRODUCTION_BUILD_DIR"
fi

# fetch assets
# rsync -zavr "$SSH_CONFIG":"$STAGING_ASSETS_DIR/" "$LOCAL_ASSETS_DIR"
if [[ "$FETCH_ASSETS" = true ]]; then
  rsync -zavr "$SSH_CONFIG":"$PRODUCTION_ASSETS_DIR/" "$LOCAL_ASSETS_DIR"
fi

